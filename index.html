<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Enhanced response card styles */
        .response-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .disclaimer-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 20%);
            border-left: 4px solid #f59e0b;
        }

        .guidance-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .step-card {
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }

        .step-card:hover {
            background: #f1f5f9;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .highlight-box {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #93c5fd;
        }

        .legal-point {
            position: relative;
            padding-left: 1.5rem;
        }

        .legal-point::before {
            content: "⚖️";
            position: absolute;
            left: 0;
            top: 0;
        }

        .key-info-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-block;
        }

        .urgency-high {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .urgency-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .urgency-low {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600">Legal AI Assistant</h1>
            <nav class="hidden md:flex space-x-6">
                <a href="#home" class="text-gray-600 hover:text-blue-600 transition-colors" onclick="scrollToSection('home')">Home</a>
                <a href="#query" class="text-gray-600 hover:text-blue-600 transition-colors" onclick="scrollToSection('query')">Ask Query</a>
                <a href="#resources" class="text-gray-600 hover:text-blue-600 transition-colors" onclick="scrollToSection('resources')">Resources</a>
                <button class="text-gray-600 hover:text-blue-600 transition-colors" onclick="openSettingsModal()">Settings</button>
            </nav>
            <button id="mobile-menu-button" class="md:hidden p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        <div id="mobile-menu" class="md:hidden hidden bg-white border-t px-4 py-2">
            <a href="#home" class="block py-2 text-gray-600" onclick="scrollToSection('home')">Home</a>
            <a href="#query" class="block py-2 text-gray-600" onclick="scrollToSection('query')">Ask Query</a>
            <a href="#resources" class="block py-2 text-gray-600" onclick="scrollToSection('resources')">Resources</a>
            <button class="block py-2 text-gray-600" onclick="openSettingsModal()">Settings</button>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="home" class="py-20 bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl md:text-5xl font-bold text-gray-800 mb-6">Get Legal Guidance Instantly</h2>
            <p class="text-xl text-gray-600 mb-8 max-w-2xl mx-auto">Ask questions about Indian law and get instant, AI-powered legal guidance. From consumer rights to constitutional matters.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
                <input id="quickSearch" type="text" placeholder="Ask a legal question..." class="flex-1 px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="performQuickSearch()" class="btn btn-primary bg-blue-600 text-white font-medium py-3 px-6 rounded-full hover:bg-blue-700 transition-colors">Search</button>
            </div>
        </div>
    </section>

    <!-- Query Section -->
    <section id="query" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">Ask Your Legal Question</h2>
            <div class="max-w-4xl mx-auto">
                <div class="bg-gray-50 p-6 rounded-lg shadow-sm mb-6">
                    <label for="legalQuery" class="block text-sm font-medium text-gray-700 mb-2">Your Legal Query</label>
                    <textarea id="legalQuery" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Describe your legal question or situation in detail..."></textarea>
                </div>
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-2">Category (Optional)</label>
                        <select id="categoryFilter" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select a category</option>
                            <option value="constitutional-law">Constitutional Law</option>
                            <option value="consumer-protection">Consumer Protection</option>
                            <option value="criminal-law">Criminal Law</option>
                            <option value="civil-law">Civil Law</option>
                            <option value="family-law">Family Law</option>
                            <option value="property-law">Property Law</option>
                            <option value="labor-law">Labor Law</option>
                            <option value="tax-law">Tax Law</option>
                        </select>
                    </div>
                    <div>
                        <label for="urgencyLevel" class="block text-sm font-medium text-gray-700 mb-2">Urgency Level</label>
                        <select id="urgencyLevel" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="general">General Information</option>
                            <option value="urgent">Urgent</option>
                            <option value="immediate">Immediate Action Required</option>
                        </select>
                    </div>
                </div>
                <div class="text-center">
                    <button id="submitBtn" class="btn btn-primary bg-blue-600 text-white font-bold py-4 px-8 rounded-full hover:bg-blue-700 transition-colors text-lg">Get Legal Guidance</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="hidden py-8 text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-gray-600">Processing your query...</p>
    </div>

    <!-- Query Results -->
    <section id="queryResults" class="py-8 bg-gray-50 hidden">
        <div class="container mx-auto px-4">
            <!-- Results will be populated here -->
        </div>
    </section>

    <!-- Resources Section -->
    <section id="resources" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">Legal Resources</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-gray-50 p-6 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openCategory('fundamental-rights')">
                    <h3 class="text-xl font-semibold mb-3">Fundamental Rights</h3>
                    <p class="text-gray-600">Learn about your constitutional rights and how they protect you.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openCategory('consumer-protection')">
                    <h3 class="text-xl font-semibold mb-3">Consumer Protection</h3>
                    <p class="text-gray-600">Understand your rights as a consumer and how to file complaints.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openCategory('rti')">
                    <h3 class="text-xl font-semibold mb-3">Right to Information</h3>
                    <p class="text-gray-600">Learn how to file RTI applications and access government information.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openCategory('labor-rights')">
                    <h3 class="text-xl font-semibold mb-3">Labor Rights</h3>
                    <p class="text-gray-600">Know your workplace rights and labor law protections.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openCategory('property-rights')">
                    <h3 class="text-xl font-semibold mb-3">Property Rights</h3>
                    <p class="text-gray-600">Understand property ownership, inheritance, and transfer laws.</p>
                </div>
                <div class="bg-gray-50 p-6 rounded-lg hover:shadow-md transition-shadow cursor-pointer" onclick="openCategory('women-rights')">
                    <h3 class="text-xl font-semibold mb-3">Women's Rights</h3>
                    <p class="text-gray-600">Learn about legal protections and rights specific to women.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Legal Tools Section -->
    <section class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">Legal Tools & Templates</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('findLocalLegalAid')">
                    <h3 class="text-lg font-semibold mb-2">Find Legal Aid</h3>
                    <p class="text-gray-600 text-sm">Locate legal aid centers in your area</p>
                </button>
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('lokAdalatInfo')">
                    <h3 class="text-lg font-semibold mb-2">Lok Adalat Info</h3>
                    <p class="text-gray-600 text-sm">Learn about alternative dispute resolution</p>
                </button>
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('freeLegalAdvice')">
                    <h3 class="text-lg font-semibold mb-2">Free Legal Advice</h3>
                    <p class="text-gray-600 text-sm">Find free legal consultation services</p>
                </button>
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('generateRTIApplication')">
                    <h3 class="text-lg font-semibold mb-2">RTI Template</h3>
                    <p class="text-gray-600 text-sm">Generate RTI application format</p>
                </button>
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('generateComplaintFormat')">
                    <h3 class="text-lg font-semibold mb-2">Complaint Format</h3>
                    <p class="text-gray-600 text-sm">Consumer complaint template</p>
                </button>
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('generateLegalNotice')">
                    <h3 class="text-lg font-semibold mb-2">Legal Notice</h3>
                    <p class="text-gray-600 text-sm">Basic legal notice template</p>
                </button>
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('generateAffidavit')">
                    <h3 class="text-lg font-semibold mb-2">Affidavit Template</h3>
                    <p class="text-gray-600 text-sm">General affidavit format</p>
                </button>
                <button class="bg-white p-6 rounded-lg shadow-sm hover:shadow-md transition-shadow text-left" onclick="showModalWithContent('recentUpdates')">
                    <h3 class="text-lg font-semibold mb-2">Recent Updates</h3>
                    <p class="text-gray-600 text-sm">Latest legal developments</p>
                </button>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-4">&copy; 2024 Legal AI Assistant. All rights reserved.</p>
            <p class="text-gray-400 text-sm">This application provides general legal information and should not be considered as professional legal advice.</p>
        </div>
    </footer>

    <!-- Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-4xl max-h-[80vh] overflow-y-auto m-4">
            <div id="modalLoading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Loading information...</p>
            </div>
            <div id="modalContent"></div>
            <div class="mt-6 text-center">
                <button class="btn btn-secondary bg-gray-200 text-gray-800 font-medium py-3 px-6 rounded-full hover:bg-gray-300 transition-colors" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full m-4">
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-6">Application Settings</h3>
                <div class="space-y-4 text-left">
                    <p>Your queries are processed in a secure environment. No personal information is stored or shared. The API key for the service is handled automatically and securely by the application's hosting environment.</p>
                    <p>The information provided is for educational purposes only. Always consult a qualified legal professional for personal legal advice.</p>
                </div>
                <div class="form-actions mt-6 flex justify-center">
                    <button class="btn btn-secondary bg-gray-200 text-gray-800 font-medium py-3 px-6 rounded-full hover:bg-gray-300 transition-colors" onclick="closeSettingsModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-[1100] space-y-2"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');

            // Toggle mobile menu visibility
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // Close mobile menu when a link is clicked
            mobileMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenu.classList.add('hidden');
                });
            });

            // Handle the submit button click
            document.getElementById('submitBtn').addEventListener('click', submitQuery);
        });

        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";
        const apiKey = "AIzaSyAuMwVNVmskHitGIWaDtwL42toUQn6WTrQ"; // API key is handled by the environment

        // Helper function to show a toast notification
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 transform translate-y-2 opacity-0
                                ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-gray-800'}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // Smooth scroll to a section
        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

        // Display a loading state for the main query result section
        function showLoading() {
            document.getElementById('queryResults').innerHTML = '';
            document.getElementById('queryResults').classList.add('hidden');
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        }

        // Hide the loading state and show results
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
            document.getElementById('queryResults').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-search mr-2"></i>Get Legal Guidance';
        }

        // Display a loading state for the modal
        function showModalLoading() {
            document.getElementById('modalContent').innerHTML = '';
            document.getElementById('modalLoading').classList.remove('hidden');
            document.getElementById('categoryModal').style.display = 'flex';
        }

        // Hide the modal loading state and show content
        function hideModalLoading() {
            document.getElementById('modalLoading').classList.add('hidden');
        }

        // Enhanced function to format API response text into readable HTML
        function formatLegalResponse(text, urgency = 'general') {
            if (!text) return '';

            // Remove markdown formatting and clean up text
            let cleanedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/### (.*?)(\n|$)/g, '<h3 class="text-xl font-bold text-gray-800 mb-3 mt-6">$1</h3>')
                .replace(/## (.*?)(\n|$)/g, '<h2 class="text-2xl font-bold text-gray-800 mb-4 mt-6">$1</h2>')
                .replace(/# (.*?)(\n|$)/g, '<h1 class="text-3xl font-bold text-gray-800 mb-4 mt-6">$1</h1>');

            // Split into sections
            const sections = cleanedText.split(/(?=<h[1-3])/);
            let formattedHtml = '';

            // Get urgency badge class
            const urgencyClass = urgency === 'immediate' ? 'urgency-high' : 
                                urgency === 'urgent' ? 'urgency-medium' : 'urgency-low';

            // Add disclaimer card
            formattedHtml += `
                <div class="disclaimer-card p-4 rounded-lg mb-6">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mt-1"></i>
                        <div>
                            <h4 class="font-bold text-yellow-800 mb-1">Important Disclaimer</h4>
                            <p class="text-yellow-800 text-sm">This information is for educational purposes only and does not constitute legal advice. For specific legal guidance, please consult with a qualified lawyer in your jurisdiction.</p>
                        </div>
                    </div>
                </div>
            `;

            // Add urgency indicator
            formattedHtml += `
                <div class="mb-6 flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-gavel mr-3 text-blue-600"></i>
                        Legal Guidance
                    </h3>
                    <span class="key-info-badge ${urgencyClass}">
                        ${urgency.charAt(0).toUpperCase() + urgency.slice(1)} Priority
                    </span>
                </div>
            `;

            sections.forEach((section, index) => {
                if (!section.trim()) return;

                // Check if section has a heading
                const hasHeading = section.match(/<h[1-3]/);
                
                if (hasHeading) {
                    // Extract heading and content
                    const headingMatch = section.match(/<(h[1-3])[^>]*>(.*?)<\/h[1-3]>/);
                    const heading = headingMatch ? headingMatch[2] : '';
                    const content = section.replace(/<h[1-3][^>]*>.*?<\/h[1-3]>/, '').trim();
                    
                    formattedHtml += `
                        <div class="guidance-section p-6 mb-6">
                            <h4 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                ${heading}
                            </h4>
                            <div class="text-gray-700 leading-relaxed">
                                ${formatContentWithBullets(content)}
                            </div>
                        </div>
                    `;
                } else {
                    // Content without heading
                    formattedHtml += `
                        <div class="guidance-section p-6 mb-6">
                            <div class="text-gray-700 leading-relaxed">
                                ${formatContentWithBullets(section)}
                            </div>
                        </div>
                    `;
                }
            });

            // Add action items section if urgent
            if (urgency === 'urgent' || urgency === 'immediate') {
                formattedHtml += `
                    <div class="highlight-box p-6 rounded-lg mb-6">
                        <h4 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
                            <i class="fas fa-clock mr-2 text-red-500"></i>
                            Immediate Action Required
                        </h4>
                        <p class="text-gray-700 mb-3">Based on the urgency of your situation, consider taking these steps:</p>
                        <div class="space-y-2">
                            <div class="legal-point">Document all relevant information and evidence</div>
                            <div class="legal-point">Consider consulting a lawyer immediately</div>
                            <div class="legal-point">Keep records of all communications</div>
                        </div>
                    </div>
                `;
            }

            // Add next steps section
            formattedHtml += `
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h4 class="text-xl font-bold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-arrow-right mr-2"></i>
                        Next Steps
                    </h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div class="step-card p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-2">1. Consult a Lawyer</h5>
                            <p class="text-gray-600 text-sm">For personalized legal advice specific to your situation</p>
                        </div>
                        <div class="step-card p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-2">2. Gather Documents</h5>
                            <p class="text-gray-600 text-sm">Collect all relevant paperwork and evidence</p>
                        </div>
                        <div class="step-card p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-2">3. Research Further</h5>
                            <p class="text-gray-600 text-sm">Use our resources section for additional information</p>
                        </div>
                        <div class="step-card p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-800 mb-2">4. Keep Records</h5>
                            <p class="text-gray-600 text-sm">Maintain proper documentation of all proceedings</p>
                        </div>
                    </div>
                </div>
            `;

            return formattedHtml;
        }

        // Helper function to format content with bullet points and structure
        function formatContentWithBullets(content) {
            if (!content) return '';
            
            return content
                .split('\n')
                .map(line => {
                    line = line.trim();
                    if (!line) return '';
                    
                    // Handle bullet points
                    if (line.startsWith('- ') || line.startsWith('• ')) {
                        return `<div class="legal-point mb-2">${line.substring(2)}</div>`;
                    }
                    
                    // Handle numbered lists
                    if (line.match(/^\d+\./)) {
                        return `<div class="legal-point mb-2">${line}</div>`;
                    }
                    
                    // Regular paragraphs
                    return `<p class="mb-3">${line}</p>`;
                })
                .join('');
        }

        // Improved function to extract text from API response
        function extractTextFromResponse(result) {
            console.log('Full API Response:', result);
            
            // Check for error responses first
            if (result?.error) {
                console.error('API Error:', result.error);
                return `API Error: ${result.error.message || JSON.stringify(result.error)}`;
            }
            
            // Multiple paths to extract text content
            if (result?.candidates?.[0]?.content?.parts?.[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            }
            
            if (result?.candidates?.[0]?.content?.parts?.[0]) {
                const part = result.candidates[0].content.parts[0];
                return part.text || part.content || JSON.stringify(part);
            }
            
            if (result?.candidates?.[0]?.content) {
                const content = result.candidates[0].content;
                return content.text || JSON.stringify(content);
            }
            
            if (result?.candidates?.[0]) {
                return JSON.stringify(result.candidates[0]);
            }
            
            // If no text found, log the structure for debugging
            console.log('Response structure not recognized. Full response:', result);
            return "No information found. Please try a different query.";
        }

        // Handle the main legal query submission
        async function submitQuery() {
            const legalQuery = document.getElementById('legalQuery').value.trim();
            if (legalQuery === '') {
                showToast('Please enter your query.', 'error');
                return;
            }

            showLoading();

            const category = document.getElementById('categoryFilter').value;
            const urgency = document.getElementById('urgencyLevel').value;

            const prompt = `Legal Query: "${legalQuery}"
            Category: ${category || 'General'}
            Urgency: ${urgency}
            
            Please provide comprehensive legal guidance in simple, easy-to-understand language. Structure your response with clear headings and bullet points. Include:
            1. A brief summary of the legal issue
            2. Relevant laws or rights that apply
            3. Practical steps the person can take
            4. Important considerations or warnings
            5. When to seek professional legal help
            
            Use simple language that anyone can understand, avoid complex legal jargon, and make the information actionable.`;

            try {
                console.log('Sending request with prompt:', prompt);
                
                const response = await fetch(API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: {
                            parts: [{ text: "You are a helpful legal assistant specializing in Indian law. Provide clear, structured, and easy-to-understand guidance. Use simple language and organize information with headings and bullet points. Always emphasize when professional legal consultation is recommended. Format responses to be scannable with clear sections for Summary, Relevant Laws, Action Steps, and Important Notes." }]
                        },
                    }),
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = extractTextFromResponse(result);

                const resultsDiv = document.getElementById('queryResults');
                resultsDiv.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="response-card p-8">
                            ${formatLegalResponse(text, urgency)}
                        </div>
                    </div>
                `;
                
                // Scroll to results
                scrollToSection('queryResults');
                showToast('Legal guidance generated!', 'success');
            } catch (error) {
                const resultsDiv = document.getElementById('queryResults');
                resultsDiv.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-red-50 border border-red-200 p-6 rounded-lg text-center">
                            <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-4"></i>
                            <h3 class="text-xl font-bold text-red-800 mb-2">Unable to Process Request</h3>
                            <p class="text-red-600">Failed to get legal guidance. Please check your internet connection and try again.</p>
                        </div>
                    </div>
                `;
                console.error("API call failed:", error);
                showToast('Failed to get legal guidance. Try again later.', 'error');
            } finally {
                hideLoading();
            }
        }

        // Open a category with a pre-defined prompt
        function openCategory(category) {
            let prompt = "";
            let title = "";

            switch (category) {
                case 'fundamental-rights':
                    title = 'Fundamental Rights';
                    prompt = "Provide a comprehensive but easy-to-understand summary of the Fundamental Rights guaranteed by the Constitution of India. Use simple language and organize with clear headings and bullet points.";
                    break;
                case 'consumer-protection':
                    title = 'Consumer Protection';
                    prompt = "Explain the Consumer Protection Act in India in simple terms. Include the rights of consumers and how to file complaints. Use clear headings and bullet points.";
                    break;
                case 'rti':
                    title = 'Right to Information (RTI)';
                    prompt = "Explain the Right to Information Act, 2005 in simple language. Include who can file RTI, what information can be requested, and the step-by-step process.";
                    break;
                case 'labor-rights':
                    title = 'Labor Rights';
                    prompt = "Provide an overview of key labor laws in India in simple terms. Explain worker rights regarding wages, working hours, and safety. Use clear structure.";
                    break;
                case 'property-rights':
                    title = 'Property Rights';
                    prompt = "Describe property rights in India in simple language. Cover ownership, inheritance, and buying/selling processes with clear headings.";
                    break;
                case 'women-rights':
                    title = 'Women\'s Rights';
                    prompt = "Summarize women's legal rights and protections in India. Include laws on domestic violence, harassment, and inheritance in simple terms.";
                    break;
            }
            showModalWithContent(category, title, prompt);
        }

        // Open the category/resource modal with API-generated content
        async function showModalWithContent(action, customTitle = null, customPrompt = null) {
            showModalLoading();
            let prompt = customPrompt || "";
            let title = customTitle || "";

            if (!customPrompt) {
                switch (action) {
                    case 'findLocalLegalAid':
                        title = 'Finding Local Legal Aid Centers';
                        prompt = "Explain how citizens can find local legal aid centers in India in simple terms. Include step-by-step instructions and mention NALSA.";
                        break;
                    case 'lokAdalatInfo':
                        title = 'Lok Adalat Information';
                        prompt = "What is a Lok Adalat? Explain in simple language its purpose, how it works, and what cases it handles. Include benefits of using Lok Adalat.";
                        break;
                    case 'freeLegalAdvice':
                        title = 'Free Legal Advice Clinics';
                        prompt = "Explain how to get free legal advice in India. Include eligibility criteria and organizations that provide these services.";
                        break;
                    case 'generateRTIApplication':
                        title = 'RTI Application Format';
                        prompt = "Provide a clear, step-by-step template for RTI application in India. Include all required components with examples.";
                        break;
                    case 'generateComplaintFormat':
                        title = 'Consumer Complaint Format';
                        prompt = "Provide a simple template for consumer complaint in India with step-by-step guidance and required details.";
                        break;
                    case 'generateLegalNotice':
                        title = 'Legal Notice Template';
                        prompt = "Provide a basic legal notice template with explanation of its purpose and required information in simple terms.";
                        break;
                    case 'generateAffidavit':
                        title = 'Affidavit Template';
                        prompt = "Provide a general affidavit template with explanation of what it is and required details in simple language.";
                        break;
                    case 'recentUpdates':
                        title = 'Recent Legal Updates';
                        prompt = "Summarize recent important legal updates in India that affect common people. Use simple language and clear headings.";
                        break;
                }
            }

            try {
                console.log('Modal request with prompt:', prompt);
                
                const response = await fetch(API_URL + apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: {
                            parts: [{ text: "You are a helpful legal assistant specializing in Indian law. Provide clear, structured, and easy-to-understand information. Use simple language, organize with headings and bullet points, and always include a disclaimer about consulting professional legal advice." }]
                        },
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                const text = extractTextFromResponse(result);

                document.getElementById('modalContent').innerHTML = `
                    <h3 class="text-2xl font-bold text-center mb-6">${title}</h3>
                    <div class="prose max-w-none">
                        ${formatLegalResponse(text)}
                    </div>
                `;
            } catch (error) {
                document.getElementById('modalContent').innerHTML = `
                    <h3 class="text-2xl font-bold text-center mb-6">${title}</h3>
                    <div class="bg-red-50 border border-red-200 p-6 rounded-lg text-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-3xl mb-4"></i>
                        <p class="text-red-600">Failed to fetch information. Please try again later.</p>
                    </div>
                `;
                console.error("Modal API call failed:", error);
            } finally {
                hideModalLoading();
            }
        }

        // Close the modal
        function closeModal() {
            document.getElementById('categoryModal').style.display = 'none';
            document.getElementById('modalContent').innerHTML = '';
        }

        // Perform a quick search on the main page
        async function performQuickSearch() {
            const query = document.getElementById('quickSearch').value.trim();
            if (query === '') {
                showToast('Please enter a search query.', 'error');
                return;
            }

            // Scroll to the query section and populate the textarea
            scrollToSection('query');
            document.getElementById('legalQuery').value = query;

            // Automatically submit the query after a small delay
            setTimeout(submitQuery, 500);
        }

        // Modal for Settings
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
    </script>
</body>
</html>
